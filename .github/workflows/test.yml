name: Terraform Provider Testing Pipeline

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

permissions:
  contents: read

jobs:
  ubuntu-test:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: üê≥ Set up QEMU for cross-architecture support
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/386

      - name: üß± Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üîÑ Checkout Terraform Provider Repository
        uses: actions/checkout@v3

      - name: üì¶ Update apt-get package list in container
        run: |
          docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace i386/debian:bullseye bash -c "apt-get update"

      - name: üì¶ Install essential packages in container
        run: |
          docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace i386/debian:bullseye bash -c "\
            apt-get update && apt-get install -y wget unzip git openjdk-17-jdk curl tar"

      - name: üì• Download and extract Go 1.22.3 in container
        run: |
          docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace i386/debian:bullseye bash -c "\
            apt-get update && apt-get install -y curl tar && \
            curl -LO https://go.dev/dl/go1.22.3.linux-386.tar.gz && \
            tar -C /usr/local -xzf go1.22.3.linux-386.tar.gz && \
            rm go1.22.3.linux-386.tar.gz && \
            /usr/local/go/bin/go version"

      - name: üõ† Sed go.mod for Go version fix
        run: |
          docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace i386/debian:bullseye bash -c "sed -i 's/^go 1\\.22\\.7/go 1.22/' go.mod"

      - name: üõ† Run go mod tidy in container (with Go installed)
        run: |
            docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace i386/debian:bullseye bash -c "\
              apt-get update && apt-get install -y curl tar && \
              curl -LO https://go.dev/dl/go1.22.3.linux-386.tar.gz && \
              tar -C /usr/local -xzf go1.22.3.linux-386.tar.gz && \
              rm go1.22.3.linux-386.tar.gz && \
              /usr/local/go/bin/go mod tidy"
        

      - name: üõ† Build Terraform provider binary in container
        run: |
          docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace \
            -e PATH=/usr/local/go/bin:$PATH \
            -e GOPATH=/workspace/go \
            -e GOARCH=386 -e GOOS=linux i386/debian:bullseye bash -c "\
              mkdir -p $GOPATH && \
              export PATH=$PATH:$GOPATH/bin && \
              go build -o terraform-provider-digicert"

      - name: üõ† Copy Terraform provider to proper path in container
        run: |
          docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace \
            -e GOPATH=/workspace/go -e GOARCH=386 -e GOOS=linux i386/debian:bullseye bash -c "\
              mkdir -p $GOPATH/bin/digicert.com/terraform/digicert/0.1.0/linux_386 && \
              cp terraform-provider-digicert $GOPATH/bin/digicert.com/terraform/digicert/0.1.0/linux_386"

      - name: ‚¨á Download Terraform 1.1.4 in container
        run: |
          docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace i386/debian:bullseye bash -c "wget https://releases.hashicorp.com/terraform/1.1.4/terraform_1.1.4_linux_386.zip"

      - name: ‚¨á Unzip Terraform in container
        run: |
          docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace i386/debian:bullseye bash -c "unzip terraform_1.1.4_linux_386.zip"

      - name: ‚¨á Move Terraform binary to /usr/local/bin in container
        run: |
          docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace i386/debian:bullseye bash -c "mv terraform /usr/local/bin/"

      - name: ‚¨á Verify Terraform installation in container
        run: |
          docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace i386/debian:bullseye bash -c "terraform version"

      - name: ‚¨á Download Maven 3.9.6 in container
        run: |
          docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace i386/debian:bullseye bash -c "curl -LO https://dlcdn.apache.org/maven/maven-3/3.9.6/binaries/apache-maven-3.9.6-bin.tar.gz"

      - name: ‚¨á Extract Maven 3.9.6 in container
        run: |
          docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace i386/debian:bullseye bash -c "tar -xzf apache-maven-3.9.6-bin.tar.gz"

      - name: ‚¨á Verify Maven installation in container
        run: |
          docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace \
            -e MAVEN_HOME=/workspace/apache-maven-3.9.6-bin/apache-maven-3.9.6 \
            -e PATH=/workspace/apache-maven-3.9.6-bin/apache-maven-3.9.6/bin:$PATH \
            i386/debian:bullseye bash -c "mvn -version"

      - name: üîÑ Clone automation test repo
        run: |
          git clone https://x-access-token:${{ secrets.QA_TOKEN }}@github.com/digicert/DigicertTerraformTests.git

      - name: ‚ñ∂ Run initial Maven test suite inside container
        run: |
          docker run --rm -v ${{ github.workspace }}/DigicertTerraformTests:/workspace -w /workspace \
            -e MAVEN_HOME=/workspace/apache-maven-3.9.6-bin/apache-maven-3.9.6 \
            -e PATH=/workspace/apache-maven-3.9.6-bin/apache-maven-3.9.6/bin:$PATH \
            i386/debian:bullseye bash -c "\
              set -e; \
              if ! mvn clean test -DsuiteXmlFile=testng.xml; then \
                echo '‚ö† Initial test failed, attempting rerun with failure.xml...'; \
                if ! mvn test -DsuiteXmlFile=failure.xml; then \
                  echo '‚ùå Final rerun also failed. Exiting with failure.'; \
                  exit 1; \
                fi; \
              fi; \
              echo '‚úÖ Tests completed successfully.' \
            "
