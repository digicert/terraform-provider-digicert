name: Terraform Provider Testing Pipeline

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

permissions:
  contents: read

jobs:
  ubuntu-test:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: ğŸ³ Set up QEMU for cross-architecture support
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/386

      - name: ğŸ§± Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”„ Checkout Terraform Provider Repository
        uses: actions/checkout@v3

      - name: ğŸ§ª Full Terraform setup & test in one container
        run: |
          docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace \
            -e GOPATH=/workspace/go \
            -e MAVEN_HOME=/workspace/apache-maven-3.9.6 \
            -e PATH=/workspace/apache-maven-3.9.6/bin:/usr/local/go/bin:$PATH \
            i386/debian:bullseye bash -c "
              set -e

              echo 'ğŸ“¦ Installing packages...'
              apt-get update && apt-get install -y \
                wget unzip curl git openjdk-17-jdk tar

              echo 'â¬‡ï¸ Installing Go...'
              curl -LO https://go.dev/dl/go1.22.3.linux-386.tar.gz
              tar -C /usr/local -xzf go1.22.3.linux-386.tar.gz
              rm go1.22.3.linux-386.tar.gz

              echo 'ğŸ”§ Adjusting go.mod...'
              sed -i 's/^go 1\\.22\\.7/go 1.22/' go.mod

              echo 'ğŸ§¹ Running go mod tidy...'
              /usr/local/go/bin/go mod tidy

              echo 'ğŸ›  Building Terraform provider...'
              mkdir -p /workspace/go
              /usr/local/go/bin/go build -o terraform-provider-digicert

              echo 'â¬‡ï¸ Installing Terraform...'
              wget https://releases.hashicorp.com/terraform/1.1.4/terraform_1.1.4_linux_386.zip
              unzip terraform_1.1.4_linux_386.zip
              mv terraform /usr/local/bin/
              terraform version

              echo 'â¬‡ï¸ Installing Maven...'
              curl -LO https://dlcdn.apache.org/maven/maven-3/3.9.6/binaries/apache-maven-3.9.6-bin.tar.gz
              tar -xzf apache-maven-3.9.6-bin.tar.gz

              echo 'âœ… Maven installed:'
              apache-maven-3.9.6/bin/mvn -version

              echo 'ğŸ”„ Cloning test repository...'
              git clone https://x-access-token:${{ secrets.QA_TOKEN }}@github.com/digicert/DigicertTerraformTests.git

              echo 'â–¶ Running Maven tests...'
              cd DigicertTerraformTests
              if ! ../apache-maven-3.9.6/bin/mvn clean test -DsuiteXmlFile=testng.xml; then
                echo 'âš ï¸ Test failed. Retrying with failure.xml...'
                if ! ../apache-maven-3.9.6/bin/mvn test -DsuiteXmlFile=failure.xml; then
                  echo 'âŒ Tests failed again.'
                  exit 1
                fi
              fi

              echo 'âœ… All tests passed.'
            "
