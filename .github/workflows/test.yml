name: Build & Test on linux_386

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      QA_TOKEN: ${{ secrets.QA_TOKEN }}  # Your secret token here

    steps:
      - name: Checkout Terraform Provider
        uses: actions/checkout@v4

      - name: Run in i386 Docker container
        run: |
          docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace i386/debian:bullseye bash -c '
            set -e

            echo "üì¶ Installing dependencies..."
            apt-get update &&
            apt-get install -y wget unzip git openjdk-17-jdk curl tar

            export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-i386
            export PATH=$JAVA_HOME/bin:$PATH

            echo "üì• Installing Go 1.22.3..."
            curl -LO https://go.dev/dl/go1.22.3.linux-386.tar.gz
            tar -C /usr/local -xzf go1.22.3.linux-386.tar.gz
            export PATH=/usr/local/go/bin:$PATH
            export GOPATH=/workspace/go
            mkdir -p "$GOPATH"
            export PATH="$PATH:$GOPATH/bin"
            export GOARCH=386
            export GOOS=linux
            go version

            echo "üõ† Tidying and building Terraform provider..."
            cd /workspace
            sed -i "s/^go 1\\.22\\.7/go 1.22/" go.mod || true
            go mod tidy
            go build -o terraform-provider-digicert
            mkdir -p "$GOPATH/bin/digicert.com/terraform/digicert/0.1.0/linux_386"
            cp terraform-provider-digicert "$GOPATH/bin/digicert.com/terraform/digicert/0.1.0/linux_386"

            echo "‚¨á Installing Terraform 1.1.4..."
            wget https://releases.hashicorp.com/terraform/1.1.4/terraform_1.1.4_linux_386.zip
            unzip terraform_1.1.4_linux_386.zip
            mv terraform /usr/local/bin/
            terraform version

            echo "‚¨á Installing Maven 3.9.6..."
            curl -LO https://dlcdn.apache.org/maven/maven-3/3.9.6/binaries/apache-maven-3.9.6-bin.tar.gz
            tar -xzf apache-maven-3.9.6-bin.tar.gz
            mv apache-maven-3.9.6 /opt/maven
            export MAVEN_HOME=/opt/maven
            export PATH=$MAVEN_HOME/bin:$PATH
            echo "‚úÖ Maven directory listing:"
            ls -l /opt/maven/bin
            mvn -version

            echo "üîÑ Cloning automation test repo..."
            git clone https://$QA_TOKEN@github.com/digicert/DigicertTerraformTests.git
            cd DigicertTerraformTests

            echo "‚ñ∂ Running initial Maven test suite..."
            if ! mvn clean test -DsuiteXmlFile=testng.xml; then
              echo "‚ö† Initial test failed, attempting rerun with failure.xml..."
              if ! mvn test -DsuiteXmlFile=failure.xml; then
                echo "‚ùå Final rerun also failed. Exiting with failure."
                exit 1
              fi
            fi

            echo "‚úÖ Tests completed successfully."
          '
