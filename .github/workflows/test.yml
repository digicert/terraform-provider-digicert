name: Terraform Provider Testing Pipeline

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

permissions:
  contents: read

jobs:
  ubuntu-test:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: üê≥ Set up QEMU for cross-architecture support
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/386

      - name: üß± Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üîÑ Checkout Terraform Provider Repository
        uses: actions/checkout@v3

      - name: üß™ Full Terraform setup & test in one container
        run: |
          docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace \
            -e GOPATH=/workspace/go \
            -e MAVEN_HOME=/workspace/apache-maven-3.9.6 \
            -e PATH=/workspace/apache-maven-3.9.6/bin:/usr/local/go/bin:$PATH \
            i386/debian:bullseye bash -c "
              set -e
      
              # Update & install all necessary packages
              apt-get update && apt-get install -y \
                wget unzip curl git openjdk-17-jdk tar
      
              # Install Go
              curl -LO https://go.dev/dl/go1.22.3.linux-386.tar.gz
              tar -C /usr/local -xzf go1.22.3.linux-386.tar.gz
              rm go1.22.3.linux-386.tar.gz
      
              # Fix go.mod Go version if needed
              sed -i 's/^go 1\\.22\\.7/go 1.22/' go.mod
      
              # Fix invalid Go import paths with '@version' (remove '@version' suffix)
              echo 'üîç Fixing invalid Go import paths...'
              find . -name '*.go' -exec sed -i -E 's@(@[0-9]+\.[0-9]+(\.[0-9]+)?)@@g' {} +
      
              # Run go mod tidy
              /usr/local/go/bin/go mod tidy
      
              # Build provider binary
              mkdir -p /workspace/go
              /usr/local/go/bin/go build -o terraform-provider-digicert
      
              # Install Terraform CLI
              wget https://releases.hashicorp.com/terraform/1.1.4/terraform_1.1.4_linux_386.zip
              unzip terraform_1.1.4_linux_386.zip
              mv terraform /usr/local/bin/
              terraform version
      
              # Download and extract Maven
              curl -LO https://dlcdn.apache.org/maven/maven-3/3.9.6/binaries/apache-maven-3.9.6-bin.tar.gz
              tar -xzf apache-maven-3.9.6-bin.tar.gz
      
              # Verify Maven installation
              apache-maven-3.9.6/bin/mvn -version
      
              # Clone the test repository using the secret token
              git clone https://x-access-token:${{ secrets.QA_TOKEN }}@github.com/digicert/DigicertTerraformTests.git
      
              # Run Maven tests with retry on failure.xml
              cd DigicertTerraformTests
              if ! apache-maven-3.9.6/bin/mvn clean test -DsuiteXmlFile=testng.xml; then
                echo '‚ö†Ô∏è Test failed. Retrying with failure.xml...'
                if ! apache-maven-3.9.6/bin/mvn test -DsuiteXmlFile=failure.xml; then
                  echo '‚ùå Tests failed again.'
                  exit 1
                fi
              fi
      
              echo '‚úÖ All tests passed.'
            "
      
      